name: Playwright E2E

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  e2e:
    name: Playwright (${{ matrix.browser }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    env:
      PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/ms-playwright
      BASE_URL: http://127.0.0.1:4000/

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: ${{ runner.os }}-playwright-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: playwright install --with-deps ${{ matrix.browser }}

      - name: Build Jekyll site
        run: bundle exec jekyll build

      - name: Start static site server
        run: |
          nohup python3 -m http.server 4000 --directory _site > server.log 2>&1 &

      - name: Wait for server
        run: |
          for i in {1..15}; do
            if curl -fsS http://127.0.0.1:4000/ > /dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Server failed to start" >&2
          exit 1

      - name: Run Playwright tests
        run: |
          mkdir -p test-results
          pytest --browser=${{ matrix.browser }} --base-url=${BASE_URL} \
            --junitxml=test-results/junit-${{ matrix.browser }}.xml \
            --html=test-results/report-${{ matrix.browser }}.html --self-contained-html

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-${{ matrix.browser }}
          path: |
            test-results/**
            server.log
          retention-days: 7

  report:
    name: Aggregate Reports
    needs: e2e
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-*
          path: artifacts
          merge-multiple: true
          if-no-artifact-found: warn

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Merge JUnit reports
        run: |
          python -m pip install --upgrade pip junitparser
          python - <<'PY'
from pathlib import Path
from junitparser import JUnitXml

reports = sorted(Path("artifacts").glob("**/junit-*.xml"))
if not reports:
    print("No JUnit reports found to merge.")
    exit(0)

merged = JUnitXml()
for report_path in reports:
    merged += JUnitXml.fromfile(report_path)

merged_path = Path("artifacts") / "junit-merged.xml"
merged.write(merged_path)
print(f"Merged {len(reports)} reports into {merged_path}")
PY

      - name: Publish summary
        if: always()
        run: |
          if [ -f artifacts/junit-merged.xml ]; then
            python - <<'PY'
from pathlib import Path
import os
from junitparser import JUnitXml

report = Path("artifacts") / "junit-merged.xml"
xml = JUnitXml.fromfile(report)
summary = f"""## Playwright Matrix Summary
- Tests: {xml.tests}
- Failures: {xml.failures}
- Errors: {xml.errors}
- Skipped: {xml.skipped}

Merged report: `{report}`"""

with open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8") as handle:
    handle.write(summary)
PY
          fi

      - name: Upload merged reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-merged
          path: artifacts
          retention-days: 7
